<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bangkok Flood Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f0f2f5;}
h1{text-align:center;margin:20px;color:#333;}
#mainMap{height:500px;width:90%;margin:20px auto;border-radius:15px;border:1px solid #ccc;}
.cardsContainer{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:40px;}
.card{width:220px;padding:15px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.2);background:white;cursor:pointer;transition:0.3s;font-weight:bold;}
.card:hover{transform:translateY(-5px);}
.cardStatus{padding:10px;border-radius:12px;color:white;font-weight:bold;text-align:center;margin-bottom:8px;font-size:16px;}
.cityName{font-size:14px;margin-bottom:10px;text-align:center;color:#222;}
.dataBlock{padding:10px;border-radius:10px;margin-bottom:6px;background:white;font-size:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.dataBlock span.lang{display:block;font-size:11px;color:#555;margin-top:2px;}
.dataBlock span.emoji{font-size:18px;margin-bottom:3px;display:block;}
.status-box{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:8px;font-size:14px;}
#toastContainer{position:fixed;bottom:20px;right:10%;transform:translateX(50%);display:flex;flex-direction:column;align-items:flex-end;gap:5px;z-index:1000;}
.toast{padding:6px 12px;border-radius:8px;color:white;font-size:13px;opacity:0;transition:all 0.5s ease;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(-10px);}
</style>
</head>
<body>
<div class="status-box">Time: <span id="currentTime"></span></div>
<h1>ğŸŒŠ Bangkok Flood Dashboard</h1>
<div id="mainMap"></div>
<div class="cardsContainer" id="cardsContainer"></div>
<div id="toastContainer"></div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBXZW1k0ESxsrosQNCdYjFSSOJJuO4hwMs",
  authDomain: "flood-detector-dashboard.firebaseapp.com",
  databaseURL: "https://flood-detector-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "flood-detector-dashboard",
  storageBucket: "flood-detector-dashboard.firebasestorage.app",
  messagingSenderId: "266532507025",
  appId: "1:266532507025:web:019d912ca354c773621e30"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Nodes
const nodes=[
  {id:"LatKrabang",city:"Lat Krabang",city_th:"à¸¥à¸²à¸”à¸à¸£à¸°à¸šà¸±à¸‡",city_jp:"ãƒ©ãƒ¼ãƒˆã‚¯ãƒ©ãƒãƒ³",lat:13.7283,lon:100.7794,type:"real",clickable:true},
  {id:"BangNa",city:"Bang Na",city_th:"à¸šà¸²à¸‡à¸™à¸²",city_jp:"ãƒãƒ¼ãƒ³ãƒŠãƒ¼",lat:13.6731,lon:100.6017,type:"simulation",clickable:true},
  {id:"DonMueang",city:"Don Mueang",city_th:"à¸”à¸­à¸™à¹€à¸¡à¸·à¸­à¸‡",city_jp:"ãƒ‰ãƒ³ãƒ ã‚¢ãƒ³",lat:13.9105,lon:100.6060,type:"simulation",clickable:true},
  {id:"PathumWan",city:"Pathum Wan",city_th:"à¸›à¸—à¸¸à¸¡à¸§à¸±à¸™",city_jp:"ãƒ‘ãƒˆã‚¥ãƒ ãƒ¯ãƒ³",lat:13.7461,lon:100.5348,type:"simulation",clickable:false,error:true},
  {id:"BangRak",city:"Bang Rak",city_th:"à¸šà¸²à¸‡à¸£à¸±à¸",city_jp:"ãƒãƒ¼ãƒ³ãƒ©ãƒƒã‚¯",lat:13.7232,lon:100.5329,type:"simulation",clickable:true},
  {id:"Chatuchak",city:"Chatuchak",city_th:"à¸ˆà¸•à¸¸à¸ˆà¸±à¸à¸£",city_jp:"ãƒãƒ£ãƒˆã‚¥ãƒãƒ£ãƒƒã‚¯",lat:13.8137,lon:100.5650,type:"simulation",clickable:true}
];

// Helpers
function getColor(status){switch(status){
  case "ERROR": return "#d3d3d3";
  case "FLASH FLOOD": return "red";
  case "FLOOD": return "orange";
  case "WARNING": return "yellow";
  case "WAITING": return "blue";
  default: return "green";
}}
function getEmoji(status){switch(status){
  case "ERROR": return "ğŸ˜";
  case "FLASH FLOOD": return "ğŸ”´";
  case "FLOOD": return "ğŸŒŠ";
  case "WARNING": return "âš ï¸";
  case "WAITING": return "â³";
  default: return "âœ…";
}}

// Map
const map=L.map('mainMap').setView([13.7563,100.5018],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

const markers={};
nodes.forEach(node=>{
  const marker=L.circleMarker([node.lat,node.lon],{radius:12,color:"green",fillColor:"green",fillOpacity:0.8}).addTo(map);
  marker.bindPopup(`${node.city} / ${node.city_th} / ${node.city_jp}`);
  if(node.clickable) marker.on('click',()=>{window.location.href=`machine.html?id=${node.id}`});
  markers[node.id]=marker;
});

// Cards
const cardsContainer=document.getElementById("cardsContainer");
nodes.forEach(node=>{
  const card=document.createElement("div");
  card.className="card"; card.id=node.id;
  card.onclick=()=>{if(node.clickable) window.location.href=`machine.html?id=${node.id}`};
  card.innerHTML=`
    <div class="cardStatus" id="${node.id}-status">Status: -</div>
    <div class="cityName">${node.city} / ${node.city_th} / ${node.city_jp}</div>
    <div class="dataBlock" id="${node.id}-water"><span class="emoji">ğŸ’§</span>Water Level: -<span class="lang">à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³: - / æ°´ä½: -</span></div>
    <div class="dataBlock" id="${node.id}-rain"><span class="emoji">ğŸŒ§ï¸</span>Rain: -<span class="lang">à¸à¸™: - / é›¨: -</span></div>
    <div class="dataBlock" id="${node.id}-humidity"><span class="emoji">ğŸ’¦</span>Humidity: -<span class="lang">à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™: - / æ¹¿åº¦: -</span></div>
    <div class="dataBlock" id="${node.id}-vibration"><span class="emoji">ğŸ“³</span>Vibration: -<span class="lang">à¸ªà¸±à¹ˆà¸™: - / æŒ¯å‹•: -</span></div>
  `;
  cardsContainer.appendChild(card);
});

// Toasts
const toastContainer = document.getElementById("toastContainer");
const activeToasts = {};

function showToast(status,node){
  if(!["FLOOD","FLASH FLOOD","WARNING"].includes(status)) return;
  const id=node.id;
  const color=getColor(status);
  const message=`${getEmoji(status)} ${status} at ${node.city}`;

  if(activeToasts[id]){
    if((status==="FLOOD"||status==="FLASH FLOOD") && activeToasts[id].status===status) return;
    fadeOutToast(activeToasts[id].element);
    delete activeToasts[id];
  }

  const toast=document.createElement("div");
  toast.className="toast";
  toast.style.background=color;
  toast.innerText=message;
  toastContainer.appendChild(toast);
  activeToasts[id]={status,element:toast};
  setTimeout(()=>toast.classList.add("show"),50);

  if(status==="WARNING"){
    setTimeout(()=>{fadeOutToast(toast); delete activeToasts[id];},3000);
  }
}

function fadeOutToast(toast){toast.classList.remove("show"); setTimeout(()=>toast.remove(),500);}

// Update
function updateCard(node,status,water,rain,humidity,vibration){
  const emoji=getEmoji(status), color=getColor(status);
  document.getElementById(`${node.id}-status`).innerText=`Status: ${status} ${emoji}`;
  document.getElementById(`${node.id}-status`).style.background=color;
  document.getElementById(`${node.id}-water`).innerHTML=`<span class="emoji">ğŸ’§</span>Water Level: ${water}<span class="lang">à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³: ${water} / æ°´ä½: ${water}</span>`;
  document.getElementById(`${node.id}-rain`).innerHTML=`<span class="emoji">ğŸŒ§ï¸</span>Rain: ${rain}<span class="lang">à¸à¸™: ${rain} / é›¨: ${rain}</span>`;
  document.getElementById(`${node.id}-humidity`).innerHTML=`<span class="emoji">ğŸ’¦</span>Humidity: ${humidity}<span class="lang">à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™: ${humidity} / æ¹¿åº¦: ${humidity}</span>`;
  document.getElementById(`${node.id}-vibration`).innerHTML=`<span class="emoji">ğŸ“³</span>Vibration: ${vibration}<span class="lang">à¸ªà¸±à¹ˆà¸™: ${vibration} / æŒ¯å‹•: ${vibration}</span>`;
  const marker=markers[node.id];
  marker.setStyle({color:color,fillColor:color});
  marker.bindPopup(`${node.city} / ${node.city_th} / ${node.city_jp}<br>Status: ${status} ${emoji}`);
}

// à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸¸à¸à¸•à¸±à¸§à¸ˆà¸²à¸ Firebase
function updateNodes(){
  nodes.forEach(node=>{
    const path = `machines/${node.id.split('-')[0]}`;
    db.ref(path).get().then(snapshot=>{
      const data = snapshot.val() || {};
      const status = data.status || "WAITING";
      const water = data.water_level || 0;
      const rain = data.rain || 0;
      const humidity = data.humidity || 0;
      const vibration = data.vibration || 0;
      updateCard(node,status,water,rain,humidity,vibration);
      showToast(status,node);
    }).catch(()=>updateCard(node,"ERROR",0,0,0,0));
  });
  document.getElementById("currentTime").innerText=new Date().toLocaleTimeString();
}

setInterval(updateNodes,2000);
</script>
</body>
</html>
