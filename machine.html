<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Machine Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f0f2f5;}
h1{text-align:center;margin:20px;color:#333;}
.container{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin:20px;}
#bigMap{flex:1 1 600px;height:450px;border-radius:15px;border:1px solid #ccc;}
.infoPanel{flex:1 1 400px;display:flex;flex-direction:column;gap:15px;}

.statusCard{
  padding:20px;border-radius:15px;
  box-shadow:0 6px 20px rgba(0,0,0,0.2);
  font-weight:bold;text-align:center;
  color:white;font-size:18px;
}

.dataBlock{
  padding:15px;border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  background:white;font-size:16px;text-align:center;
}
.dataBlock span.lang{display:block;font-size:12px;color:#555;margin-top:3px;}
.dataBlock span.emoji{font-size:22px;margin-bottom:5px;display:block;}

.chartCard{
  padding:15px;border-radius:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.15);
  background:white;
}

.status-box{
  position:fixed;top:10px;left:10px;
  background:rgba(0,0,0,0.7);color:white;
  padding:10px;border-radius:8px;font-size:14px;
}
.marker-label {
  background-color: rgba(255,255,255,0.8);
  color: #222;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="status-box">Time: <span id="currentTime"></span></div>
<h1 id="machineTitle">Machine Dashboard</h1>

<div class="container">
  <div id="bigMap"></div>
  <div class="infoPanel">

    <div class="statusCard" id="statusCard">Status: WAITING</div>

    <div class="dataBlock" id="waterBlock">
      <span class="emoji">ğŸ’§</span>
      Water Level: -
      <span class="lang">à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³ / æ°´ä½</span>
    </div>

    <div class="dataBlock" id="rainBlock">
      <span class="emoji">ğŸŒ§ï¸</span>
      Rain: -
      <span class="lang">à¸à¸™ / é›¨</span>
    </div>

    <div class="dataBlock" id="humidityBlock">
      <span class="emoji">ğŸ’¦</span>
      Humidity: -
      <span class="lang">à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™ / æ¹¿åº¦</span>
    </div>

    <div class="dataBlock" id="vibrationBlock">
      <span class="emoji">ğŸ“³</span>
      Vibration: -
      <span class="lang">à¸ªà¸±à¹ˆà¸™ / æŒ¯å‹•</span>
    </div>

    <div class="chartCard">
      <canvas id="trendChart" height="200"></canvas>
    </div>
  </div>
</div>

<script>
/* ===== Firebase ===== */
firebase.initializeApp({
  databaseURL: "https://flood-detector-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app/"
});
const db = firebase.database();

// ===== Machine ID =====
const rawId = new URLSearchParams(location.search).get("id") || "LatKrabang";
const machineId = rawId
  .replace("-Real","")
  .replace("-Sim","")
  .replace("-Error","");

// ===== à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸·à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡ =====
const cityNames = {
  LatKrabang: "Lat Krabang à¸¥à¸²à¸”à¸à¸£à¸°à¸šà¸±à¸‡ ãƒ©ãƒ¼ãƒˆã‚¯ãƒ©ãƒãƒ³",
  BangNa: "Bang Na à¸šà¸²à¸‡à¸™à¸² ãƒãƒ¼ãƒ³ãƒŠãƒ¼",
  BangRak: "Bang Rak à¸šà¸²à¸‡à¸£à¸±à¸ ãƒãƒ¼ãƒ³ãƒ©ãƒƒã‚¯",
  Chatuchak: "Chatuchak à¸ˆà¸•à¸¸à¸ˆà¸±à¸à¸£ ãƒãƒ£ãƒˆã‚¥ãƒãƒ£ãƒƒã‚¯",
  DonMueang: "Don Mueang à¸”à¸­à¸™à¹€à¸¡à¸·à¸­à¸‡ ãƒ‰ãƒ³ãƒ ã‚¢ãƒ³",
  PathumWan: "Pathum Wan à¸›à¸—à¸¸à¸¡à¸§à¸±à¸™ ãƒ‘ãƒˆã‚¥ãƒ ãƒ¯ãƒ³"
};

const cityDisplay = cityNames[machineId] || machineId;

// à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ title à¹à¸¥à¸° h1
document.title = `${cityDisplay} - Dashboard`;
document.getElementById("machineTitle").innerText = `${cityDisplay} Dashboard`;


/* ===== Map ===== */
const locations = {
  LatKrabang:[13.7283,100.7794],
  BangNa:[13.6731,100.6017],
  BangRak:[13.7232,100.5329],
  Chatuchak:[13.8137,100.5650],
  DonMueang:[13.9105,100.6060],
  PathumWan:[13.7461,100.5348]
};

const map = L.map("bigMap").setView(locations[machineId],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Marker à¸à¸£à¹‰à¸­à¸¡à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸·à¸­à¸‡
const marker = L.circleMarker(locations[machineId], {
  radius: 14,
  fillOpacity: 0.9
}).addTo(map);

// à¹ƒà¸ªà¹ˆ Label à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸·à¸­à¸‡à¸•à¸£à¸‡ Marker
marker.bindTooltip(cityDisplay, {permanent: true, direction: "top", offset:[0,-10], className:"marker-label"}).openTooltip();
/* ===== Chart ===== */
const chart = new Chart(document.getElementById("trendChart"),{
  type:"line",
  data:{
    labels:Array(10).fill(""),
    datasets:[
      {label:"Water",data:Array(10).fill(0)},
      {label:"Rain",data:Array(10).fill(0)}
    ]
  }
});

/* ===== Color ===== */
function color(status){
  return {
    NORMAL:"green",
    WARNING:"yellow",
    FLOOD:"orange",
    "FLASH FLOOD":"red",
    WAITING:"blue",
    ERROR:"gray"
  }[status] || "blue";
}

/* ===== Firebase Listener ===== */
db.ref("machines/"+machineId).on("value", snap=>{
  const d = snap.val();
  if(!d) return;

  document.getElementById("statusCard").innerText = "Status: "+d.status;
  document.getElementById("statusCard").style.background = color(d.status);

  document.getElementById("waterBlock").innerHTML =
    `<span class="emoji">ğŸ’§</span>Water Level: ${d.water_level}
     <span class="lang">à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³ / æ°´ä½</span>`;

  document.getElementById("rainBlock").innerHTML =
    `<span class="emoji">ğŸŒ§ï¸</span>Rain: ${d.rain}
     <span class="lang">à¸à¸™ / é›¨</span>`;

  document.getElementById("humidityBlock").innerHTML =
    `<span class="emoji">ğŸ’¦</span>Humidity: ${d.humidity}
     <span class="lang">à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™ / æ¹¿åº¦</span>`;

  document.getElementById("vibrationBlock").innerHTML =
    `<span class="emoji">ğŸ“³</span>Vibration: ${d.vibration}
     <span class="lang">à¸ªà¸±à¹ˆà¸™ / æŒ¯å‹•</span>`;

  marker.setStyle({color:color(d.status),fillColor:color(d.status)});

  chart.data.datasets[0].data.push(d.water_level);
  chart.data.datasets[0].data.shift();
  chart.data.datasets[1].data.push(d.rain);
  chart.data.datasets[1].data.shift();
  chart.update();
});

/* ===== Clock ===== */
setInterval(()=>{
  document.getElementById("currentTime").innerText =
    new Date().toLocaleTimeString();
},1000);
</script>
</body>
</html>
