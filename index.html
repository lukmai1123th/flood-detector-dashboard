<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bangkok Flood Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f0f2f5;}
h1{text-align:center;margin:20px;color:#333;}
#mainMap{height:500px;width:90%;margin:20px auto;border-radius:15px;border:1px solid #ccc;}
.cardsContainer{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:40px;}
.card{width:220px;padding:15px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.2);background:white;cursor:pointer;transition:0.3s;font-weight:bold;}
.card:hover{transform:translateY(-5px);}
.cardStatus{padding:10px;border-radius:12px;color:white;font-weight:bold;text-align:center;margin-bottom:8px;font-size:16px;}
.cityName{font-size:14px;margin-bottom:10px;text-align:center;color:#222;}
.dataBlock{padding:10px;border-radius:10px;margin-bottom:6px;background:white;font-size:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.dataBlock span.lang{display:block;font-size:11px;color:#555;margin-top:2px;}
.dataBlock span.emoji{font-size:18px;margin-bottom:3px;display:block;}
.status-box{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:8px;font-size:14px;}
#toastContainer{position:fixed;bottom:20px;right:10%;transform:translateX(50%);display:flex;flex-direction:column;align-items:flex-end;gap:5px;z-index:1000;}
.toast{padding:6px 12px;border-radius:8px;color:white;font-size:13px;opacity:0;transition:all 0.5s ease;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(-10px);}
.marker-label {
  background: rgba(255,255,255,0.8);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  color: #222;
  font-weight: bold;
  pointer-events: none;
}

</style>
</head>
<body>
<div class="status-box">Time: <span id="currentTime"></span></div>
<h1>üåä Bangkok Flood Dashboard</h1>
<div id="mainMap"></div>
<div class="cardsContainer" id="cardsContainer"></div>
<div id="toastContainer"></div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBXZW1k0ESxsrosQNCdYjFSSOJJuO4hwMs",
  authDomain: "flood-detector-dashboard.firebaseapp.com",
  databaseURL: "https://flood-detector-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "flood-detector-dashboard",
  storageBucket: "flood-detector-dashboard.firebasestorage.app",
  messagingSenderId: "266532507025",
  appId: "1:266532507025:web:019d912ca354c773621e30"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Nodes
const nodes=[
  {id:"LatKrabang",city:"Lat Krabang",city_th:"‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á",city_jp:"„É©„Éº„Éà„ÇØ„É©„Éê„É≥",lat:13.7283,lon:100.7794,type:"real",clickable:true},
  {id:"BangNa",city:"Bang Na",city_th:"‡∏ö‡∏≤‡∏á‡∏ô‡∏≤",city_jp:"„Éê„Éº„É≥„Éä„Éº",lat:13.6731,lon:100.6017,type:"simulation",clickable:true},
  {id:"DonMueang",city:"Don Mueang",city_th:"‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á",city_jp:"„Éâ„É≥„É†„Ç¢„É≥",lat:13.9105,lon:100.6060,type:"simulation",clickable:true},
  {id:"PathumWan",city:"Pathum Wan",city_th:"‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô",city_jp:"„Éë„Éà„Ç•„É†„ÉØ„É≥",lat:13.7461,lon:100.5348,type:"simulation",clickable:true},
  {id:"BangRak",city:"Bang Rak",city_th:"‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å",city_jp:"„Éê„Éº„É≥„É©„ÉÉ„ÇØ",lat:13.7232,lon:100.5329,type:"simulation",clickable:true},
  {id:"Chatuchak",city:"Chatuchak",city_th:"‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£",city_jp:"„ÉÅ„É£„Éà„Ç•„ÉÅ„É£„ÉÉ„ÇØ",lat:13.8137,lon:100.5650,type:"simulation",clickable:true}
];

// Helpers
function getColor(status){switch(status){
  case "ERROR": return "#d3d3d3";
  case "FLASH FLOOD": return "red";
  case "FLOOD": return "orange";
  case "WARNING": return "yellow";
  case "WAITING": return "blue";
  default: return "green";
}}
function getEmoji(status){switch(status){
  case "ERROR": return "üòû";
  case "FLASH FLOOD": return "üî¥";
  case "FLOOD": return "üåä";
  case "WARNING": return "‚ö†Ô∏è";
  case "WAITING": return "‚è≥";
  default: return "‚úÖ";
}}

// Map
const map=L.map('mainMap').setView([13.7563,100.5018],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

const markers={};
nodes.forEach(node=>{
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á CircleMarker
  const marker=L.circleMarker([node.lat,node.lon],{
    radius:12,
    color:"green",
    fillColor:"green",
    fillOpacity:0.8
  }).addTo(map);

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö tooltip
  marker.bindTooltip(
    `${node.city} / ${node.city_th} / ${node.city_jp}`,
    {permanent:true, direction:'top', offset:[0,-15], className:'marker-label'}
  );

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ machine.html ‡∏´‡∏≤‡∏Å clickable
  if(node.clickable){
    marker.on('click',()=>{window.location.href=`machine.html?id=${node.id}`});
  }

  markers[node.id]=marker;
});


// Cards
const cardsContainer=document.getElementById("cardsContainer");
nodes.forEach(node=>{
  const card=document.createElement("div");
  card.className="card"; card.id=node.id;
  card.onclick=()=>{if(node.clickable) window.location.href=`machine.html?id=${node.id}`};
  card.innerHTML=`
    <div class="cardStatus" id="${node.id}-status">Status: -</div>
    <div class="cityName">${node.city} / ${node.city_th} / ${node.city_jp}</div>
    <div class="dataBlock" id="${node.id}-water"><span class="emoji">üíß</span>Water Level: -<span class="lang">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: - / Ê∞¥‰Ωç: -</span></div>
    <div class="dataBlock" id="${node.id}-rain"><span class="emoji">üåßÔ∏è</span>Rain: -<span class="lang">‡∏ù‡∏ô: - / Èõ®: -</span></div>
    <div class="dataBlock" id="${node.id}-humidity"><span class="emoji">üí¶</span>Humidity: -<span class="lang">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: - / ÊπøÂ∫¶: -</span></div>
    <div class="dataBlock" id="${node.id}-vibration"><span class="emoji">üì≥</span>Vibration: -<span class="lang">‡∏™‡∏±‡πà‡∏ô: - / ÊåØÂãï: -</span></div>
  `;
  cardsContainer.appendChild(card);
});

// Toasts
const toastContainer = document.getElementById("toastContainer");

// ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡πÄ‡∏ß‡∏•‡∏≤
const lastToast = {}; // { LatKrabang: {status:"WARNING", time: 1671234567890} }

function showToast(status, node){
  if(!["WARNING","FLOOD","FLASH FLOOD"].includes(status)) return;

  const id = node.id;
  const color = getColor(status);
  const message = `${getEmoji(status)} ${status} at ${node.city}`;

  const now = Date.now();

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ toast ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô status ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå
  if(lastToast[id] && lastToast[id].status === status && (now - lastToast[id].time < 10000)){
    return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ã‡πâ‡∏≥
  }

  lastToast[id] = {status, time: now};

  const toast = document.createElement("div");
  toast.className = "toast";
  toast.style.background = color;
  toast.innerText = message;
  toastContainer.appendChild(toast);

  // ‡πÇ‡∏ä‡∏ß‡πå
  setTimeout(() => toast.classList.add("show"), 50);

  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ Toast ‡∏´‡∏≤‡∏¢
  setTimeout(() => {
    fadeOutToast(toast);
  }, 3000);
}

function fadeOutToast(toast){
  toast.classList.remove("show");
  setTimeout(() => toast.remove(), 500);
}


// Update
function updateCard(node,status,water,rain,humidity,vibration){
  const emoji=getEmoji(status), color=getColor(status);
  document.getElementById(`${node.id}-status`).innerText=`Status: ${status} ${emoji}`;
  document.getElementById(`${node.id}-status`).style.background=color;
  document.getElementById(`${node.id}-water`).innerHTML=`<span class="emoji">üíß</span>Water Level: ${water}<span class="lang">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${water} / Ê∞¥‰Ωç: ${water}</span>`;
  document.getElementById(`${node.id}-rain`).innerHTML=`<span class="emoji">üåßÔ∏è</span>Rain: ${rain}<span class="lang">‡∏ù‡∏ô: ${rain} / Èõ®: ${rain}</span>`;
  document.getElementById(`${node.id}-humidity`).innerHTML=`<span class="emoji">üí¶</span>Humidity: ${humidity}<span class="lang">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${humidity} / ÊπøÂ∫¶: ${humidity}</span>`;
  document.getElementById(`${node.id}-vibration`).innerHTML=`<span class="emoji">üì≥</span>Vibration: ${vibration}<span class="lang">‡∏™‡∏±‡πà‡∏ô: ${vibration} / ÊåØÂãï: ${vibration}</span>`;
  const marker=markers[node.id];
  marker.setStyle({color:color,fillColor:color});
  marker.bindPopup(`${node.city} / ${node.city_th} / ${node.city_jp}<br>Status: ${status} ${emoji}`);
}

// ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å Firebase
function updateNodes(){
  nodes.forEach(node=>{
    const path = `machines/${node.id.split('-')[0]}`;
    db.ref(path).get().then(snapshot=>{
      const data = snapshot.val() || {};
      const status = data.status || "WAITING";
      const water = data.water_level || 0;
      const rain = data.rain || 0;
      const humidity = data.humidity || 0;
      const vibration = data.vibration || 0;
      updateCard(node,status,water,rain,humidity,vibration);
      showToast(status,node);
    }).catch(()=>updateCard(node,"ERROR",0,0,0,0));
  });
  document.getElementById("currentTime").innerText=new Date().toLocaleTimeString();
}

setInterval(updateNodes,2000);
</script>
</body>
</html>
